module circle where

import experiments/funext
import experiments/inf-group

def Î©Â¹SÂ¹ := Path SÂ¹ base base

def SÂ¹-rec (Î² : U) : Î  (b : Î²), Path Î² b b â†’ SÂ¹ â†’ Î² :=
SÂ¹-ind (Î» (x : SÂ¹), Î²)

def triv : SÂ¹ â†’ SÂ¹ := SÂ¹-rec SÂ¹ base loop

def triv-eq-id : Î  (x : SÂ¹), Path SÂ¹ (triv x) x :=
SÂ¹-ind (Î» (x : SÂ¹), Path SÂ¹ (triv x) x) (idp base) (idp (idp base))

def const-SÂ¹ : SÂ¹ â†’ SÂ¹ := SÂ¹-rec SÂ¹ base (idp base)

def const-eq-const : Î  (x : SÂ¹), Path SÂ¹ (const-SÂ¹ x) base :=
SÂ¹-ind (Î» (x : SÂ¹), Path SÂ¹ (const-SÂ¹ x) base) (idp base) (idp (idp base))

def rot (x : SÂ¹) : Path SÂ¹ x x :=
SÂ¹-ind (Î» (y : SÂ¹), Path SÂ¹ y y) loop (idp loop) x

def SÂ¹-apd (Î² : Î  (x : SÂ¹), SÂ¹ â†’ U) (b : Î  (x : SÂ¹), Î² x base)
  (â„“ : Î  (x : SÂ¹), Path (Î² x base) (coe (apd (Î² x) loop) (b x)) (b x)) (f : SÂ¹ â†’ SÂ¹) :
   Path (Î² base (f base))
        (coe (apd (Î» (x : SÂ¹), Î² x (f x)) loop)
                  (SÂ¹-ind (Î² base) (b base) (â„“ base) (f base)))
        (SÂ¹-ind (Î² base) (b base) (â„“ base) (f base)) :=
?

def SÂ¹-apdâ€² (Î² : Î  (x : SÂ¹), SÂ¹ â†’ U) (b : Î  (x : SÂ¹), Î² x base)
  (â„“ : Î  (x : SÂ¹), Path (Î² x base) (coe (apd (Î² x) loop) (b x)) (b x)) (f : SÂ¹ â†’ SÂ¹) :
   Path (Î² base (f base))
        (coe (apd (Î» (x : SÂ¹), Î² x (f x)) loop)
                  (SÂ¹-ind (Î² base) (b base) (â„“ base) (f base)))
        (SÂ¹-ind (Î² base) (b base) (â„“ base) (f base)) :=
apd (Î» (x : SÂ¹), SÂ¹-ind (Î² x) (b x) (â„“ x) (f x)) loop

def Î¼ (x : SÂ¹) : SÂ¹ â†’ SÂ¹ := SÂ¹-rec SÂ¹ x (rot x)
def Ïƒ (x : SÂ¹) := Î¼ x x

def Î¼-base-left : Î  (x : SÂ¹), Path SÂ¹ (Î¼ base x) x :=
SÂ¹-ind (Î» (x : SÂ¹), Path SÂ¹ (Î¼ base x) x) (idp base) (idp (idp base))

def Î¼-base-right (x : SÂ¹) : Path SÂ¹ (Î¼ x base) x :=
idp x

def double-loop := ap SÂ¹ SÂ¹ Ïƒ base base
def triple-loop := ap SÂ¹ SÂ¹ (Î» (x : SÂ¹), Î¼ x (Ïƒ x)) base base

def Î¹ : SÂ¹ â†’ SÂ¹ := SÂ¹-rec SÂ¹ base loopâ»Â¹
def Î¹-test := ap SÂ¹ SÂ¹ Î¹ base base (loop â¬ loop â¬ loop)

def helix : SÂ¹ â†’ U :=
SÂ¹-ind (Î» (_ : SÂ¹), U) Z Z-succ-path

def MÃ¶bius : SÂ¹ â†’ U :=
SÂ¹-ind (Î» (_ : SÂ¹), U) ğŸ bool-neg-path

def encode (x : SÂ¹) (p : Path SÂ¹ base x) : helix x :=
subst SÂ¹ helix base x p Z-zero

-- it computes!
def winding := encode base
def oddity (l : Î©Â¹SÂ¹) := subst SÂ¹ MÃ¶bius base base l 0â‚‚

def turn (l : Î©Â¹SÂ¹) := l â¬ loop
def back-turn (l : Î©Â¹SÂ¹) := l â¬ loopâ»Â¹

def power : Z â†’ Î©Â¹SÂ¹ :=
Z-rec Î©Â¹SÂ¹ (N-rec Î©Â¹SÂ¹ (idp base) (Î» (_ : N), turn))
           (N-rec Î©Â¹SÂ¹ loopâ»Â¹ (Î» (_ : N), back-turn))

def decode : Î  (x : SÂ¹), helix x â†’ Path SÂ¹ base x :=
SÂ¹-ind (Î» (x : SÂ¹), helix x â†’ Path SÂ¹ base x) power
  (funext Z (Î» (_ : Z), Î©Â¹SÂ¹) (Î» (z : Z), power (Z-pred z) â¬ loop) power
    (Z-ind (Î» (z : Z), Path Î©Â¹SÂ¹ (power (Z-pred z) â¬ loop) (power z))
      (N-ind (Î» (m : N), Path Î©Â¹SÂ¹ (power (Z-pred (pos m)) â¬ loop) (power (pos m)))
        (idp (idp base)) (Î» (m : N) (p : Path Î©Â¹SÂ¹ (power (Z-pred (pos m)) â¬ loop) (power (pos m))), idp (power (pos (succ m)))))
      (Î» (n : N), idp (power (neg n)))))

def decode-encode : Î  (x : SÂ¹) (p : Path SÂ¹ base x), Path (Path SÂ¹ base x) (decode x (encode x p)) p :=
Jâ€² SÂ¹ base (Î» (x : SÂ¹) (p : Path SÂ¹ base x), Path (Path SÂ¹ base x) (decode x (encode x p)) p) (idp (idp base))

def encode-decodeáµ€ (z : Z) :=
Path Z (encode base (decode base z)) z

def encode-decode : Î  (z : Z), Path Z (encode base (decode base z)) z :=
Z-ind encode-decodeáµ€
  (N-ind (Î» (m : N), encode-decodeáµ€ (pos m)) (idp (pos zero))
         (Î» (m : N), ap Z Z Z-succ (encode base (decode base (pos m))) (pos m)))
  (N-ind (Î» (m : N), encode-decodeáµ€ (neg m)) (idp (neg zero))
         (Î» (m : N), ap Z Z Z-pred (encode base (decode base (neg m))) (neg m)))

def fundamental-group : equiv Î©Â¹SÂ¹ Z :=
mkeqv Î©Â¹SÂ¹ Z (encode base) (decode base) (decode-encode base) (decode base) (encode-decode)

def Ï€â‚SÂ¹ : âˆ-group :=
mk-âˆ-group Î©Â¹SÂ¹ (Î» (x y : Î©Â¹SÂ¹), x â¬ y) (Î» (x : Î©Â¹SÂ¹), xâ»Â¹) (idp base)
 (Î» (x y z : Î©Â¹SÂ¹), idp (x â¬ y â¬ z)) (Î» (x : Î©Â¹SÂ¹), idp x) (Î» (x : Î©Â¹SÂ¹), idp (idp base))

def integer : âˆ-group :=
Î£-mk is-âˆ-group Z (coe (apd is-âˆ-group (ua Î©Â¹SÂ¹ Z fundamental-group)) Ï€â‚SÂ¹.2)

def Z-add : Z â†’ Z â†’ Z := opâˆ integer
def Z-assoc : Î  (x y z : Z), Path Z (Z-add x (Z-add y z)) (Z-add (Z-add x y) z) := assocâˆ integer

-- :-(
--def Z-zero-eq-zero : Path Z (pos zero) (pos zero) :=
--Z-assoc (pos zero) (pos zero) (pos zero)
